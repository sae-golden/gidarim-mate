# IVF 앱 - 치료 기록 멀티 사이클 구조

## 개요
사용자가 여러 번의 채취와 이식을 거칠 수 있으므로, 이를 체계적으로 관리하는 구조입니다.

## 핵심 용어 (커뮤니티 실제 사용 기준)

| 용어 | 의미 |
|------|------|
| 1차 채취, 2차 채취 | 난자 채취 사이클 (과배란~채취~배양) |
| 신선이식 | 채취 직후 바로 이식 |
| 동결 1차, 2차... | 동결배아로 이식 시도 횟수 |
| 동결배아 | 냉동 보관 중인 배아 |

## 케이스별 시나리오

### 케이스 1: 순탄한 경우 (신선이식 성공)
```
과배란 → 채취 12개 → 신선이식 → 임신 성공 🎉
```

**화면:**
```
┌─────────────────────────────────────────┐
│ 🥚 1차 채취 (2024.08)           [현재]  │
│    채취 12개 → 배반포 3개 → 동결 2개   │
│                                         │
│    └ 신선이식 ✅ 성공!                  │
│                                         │
│ 💜 축하해요! 임신에 성공했어요          │
│                                         │
│ [동결배아 2개 보관중]                   │
└─────────────────────────────────────────┘
```

---

### 케이스 2: 동결이식으로 성공
```
채취 → 신선 ❌ → 동결1차 ❌ → 동결2차 → 성공 🎉
```

**화면 (동결 2차 진행 중):**
```
┌─────────────────────────────────────────┐
│ 🥚 1차 채취 (2024.08)           [현재]  │
│    채취 12개 → 배반포 3개              │
│    남은 동결배아: 1개                   │
│                                         │
│    ├ 신선이식 ❌ (8/20)                 │
│    ├ 동결 1차 ❌ (10/15)                │
│    └ 동결 2차 → 진행중 ⏳               │
│                                         │
│ 📋 치료 단계                            │
│    ✅ 과배란                            │
│    ✅ 채취                              │
│    ✅ 이식 대기                         │
│    ▶️ 이식 → 진행중                     │
│    ○ 판정 → 예정                        │
└─────────────────────────────────────────┘
```

---

### 케이스 3: 동결배아 소진 → 재채취
```
1차 채취 → 신선 ❌ → 동결1차 ❌ → 동결2차 ❌ → 배아 소진 → 2차 채취
```

**화면 (동결배아 소진 시):**
```
┌─────────────────────────────────────────┐
│ 🥚 1차 채취 (2024.08)                   │
│    채취 12개 → 배반포 3개               │
│    남은 동결배아: 0개                   │
│                                         │
│    ├ 신선이식 ❌                        │
│    ├ 동결 1차 ❌                        │
│    └ 동결 2차 ❌                        │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │  💪 포기하지 마세요                  │ │
│ │  새로운 시작을 응원해요              │ │
│ │                                     │ │
│ │      [🌱 새로운 채취 시작하기]       │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

**[새로운 채취 시작하기] 탭 후:**
```
┌─────────────────────────────────────────┐
│ 🥚 2차 채취                     [현재]  │
│    시작일: 2025.01.01                   │
│                                         │
│ 📋 치료 단계                            │
│    ▶️ 과배란 → 진행중                   │
│    ○ 채취 → 예정                        │
│    ○ 이식 대기 → 예정                   │
│    ○ 이식 → 예정                        │
│    ○ 판정 → 예정                        │
│                                         │
│ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │
│ 📂 [지난 기록 보기]                     │
│    1차 채취 (2024.08) - 이식 3회        │
└─────────────────────────────────────────┘
```

---

## 히스토리 화면

**[지난 기록 보기] 탭 시:**
```
┌─────────────────────────────────────────┐
│ ← 지난 기록                             │
├─────────────────────────────────────────┤
│                                         │
│ 📊 전체 통계                            │
│    총 채취: 2회 | 총 이식: 5회          │
│    총 채취 난자: 22개                   │
│                                         │
│ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │
│                                         │
│ 🥚 2차 채취 (2025.01) ← 현재 진행중     │
│    채취 10개 → 배반포 2개               │
│    동결 1차 진행중                      │
│                                      >  │
│                                         │
│ 🥚 1차 채취 (2024.08)                   │
│    채취 12개 → 배반포 3개               │
│    신선 ❌ → 동결1차 ❌ → 동결2차 ❌    │
│                                      >  │
│                                         │
└─────────────────────────────────────────┘
```

---

## 데이터 구조

```dart
class User {
  List<RetrievalCycle> retrievalCycles;  // 채취 사이클들
  RetrievalCycle? get currentCycle => 
    retrievalCycles.firstWhere((c) => c.isActive, orElse: () => null);
}

class RetrievalCycle {
  int cycleNumber;              // 1차, 2차...
  DateTime startDate;
  bool isActive;                // 현재 진행 중인 사이클인지
  
  // 채취 관련 데이터
  StimulationData? stimulation;
  RetrievalData? retrieval;
  List<LabResult> labResults;   // 수정, 배양 결과
  
  // 동결배아 관리
  int totalFrozenEmbryos;       // 총 동결 배아 수
  int usedFrozenEmbryos;        // 사용한 동결 배아 수
  int get remainingEmbryos => totalFrozenEmbryos - usedFrozenEmbryos;
  
  // 이식 기록들
  List<TransferAttempt> transfers;
}

class TransferAttempt {
  TransferType type;            // fresh (신선) / frozen (동결)
  int? frozenAttemptNumber;     // 동결 1차, 2차... (동결이식인 경우)
  DateTime date;
  TransferStatus status;        // inProgress, success, fail
  ResultData? result;           // 판정 결과
  String? memo;
}

enum TransferType {
  fresh,    // 신선이식
  frozen,   // 동결이식
}

enum TransferStatus {
  inProgress,  // 진행중
  success,     // 성공
  fail,        // 실패
}
```

---

## 상태별 UI 변화

| 상태 | 메인 화면 | 표시 내용 | 버튼/액션 |
|------|-----------|-----------|-----------|
| 채취 진행중 | 5단계 치료 단계 | 과배란~채취 단계 | - |
| 이식 대기중 | 5단계 치료 단계 | 병원 결과 입력 | - |
| 이식 진행중 | 이식 차수 표시 | 신선/동결 N차 | - |
| 임신 성공 | 축하 메시지 | 🎉 | 동결배아 N개 보관중 표시 |
| 이식 실패 (배아 남음) | 다음 이식 준비 | 남은 동결배아 수 | [다음 동결이식 시작] |
| 동결배아 소진 | 응원 메시지 | 💪 | [새로운 채취 시작하기] |

---

## 새 채취 시작 플로우

1. 동결배아 소진 또는 사용자가 새 채취 원할 때
2. [새로운 채취 시작하기] 버튼 표시
3. 탭하면 확인 다이얼로그:
   ```
   ┌─────────────────────────────────────┐
   │ 새로운 채취를 시작할까요?           │
   │                                     │
   │ 기존 기록은 '지난 기록'에서         │
   │ 언제든 확인할 수 있어요.            │
   │                                     │
   │     [취소]        [시작하기]        │
   └─────────────────────────────────────┘
   ```
4. 시작하면 새 사이클 생성, 기존은 히스토리로

---

## 이식 추가 플로우

**동결이식 시작 시:**
```
┌─────────────────────────────────────────┐
│ 동결이식을 시작할까요?                  │
│                                         │
│ 남은 동결배아: 2개                      │
│ 이번이 동결 2차 이식이에요.             │
│                                         │
│     [취소]        [시작하기]            │
└─────────────────────────────────────────┘
```

---

## 주의사항

- 현재 진행 중인 사이클은 항상 1개만 존재
- 과거 기록은 수정 가능하나, 메인에서는 현재 사이클만 표시
- 동결배아 수는 이식할 때마다 자동 차감
- 성공 시에도 남은 동결배아가 있으면 보관중으로 표시

---

## 우선순위

### Phase 1 (필수)
1. 단일 채취 사이클 + 다중 이식 기록
2. 신선/동결 이식 구분
3. 남은 동결배아 수 관리

### Phase 2
4. [새로운 채취 시작하기] 기능
5. 히스토리 화면
6. 전체 통계

### Phase 3
7. 성공 축하 화면
8. 응원 메시지 시스템
