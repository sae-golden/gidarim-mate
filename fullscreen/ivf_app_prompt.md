# IVF 앱 화면 개선 개발 요청

## 프로젝트 개요
Flutter 기반 IVF(시험관 아기) 치료 관리 앱의 두 가지 핵심 화면을 개선합니다.
1. 치료 기록 탭 - 단계별 결과 추적 및 수정
2. 약물 추가 화면 - 4단계 → 1페이지로 간소화

---

# Part 1: 치료 기록 탭 개선

## 개요
IVF 치료 과정을 **사용자 행동 중심 5단계**로 추적합니다.
수정/배양은 별도 단계가 아니라, "이식 대기" 단계에서 병원 결과를 자유롭게 기록하는 방식입니다.

## 설계 철학
- 수정/배양은 사용자가 하는 게 아니라 **병원에서 전화로 알려주는 결과**
- 결과를 별도 "단계"로 만들지 않고, 대기 기간에 자유롭게 추가
- 핵심 숫자만 기록, 상세 정보는 메모로 처리

## 화면 구조

### 1. 상단 요약 카드
```
┌────────────────────────────────────────────┐
│  🔄 1차 시도                    [편집]     │
│  ─────────────────────────────────────────  │
│  완료    남은 횟수   D-Day                  │
│  42회     23회       5일                    │
│  ─────────────────────────────────────────  │
│  📊 결과 요약                              │
│  채취 12 → 수정 8 → Day3 5 → 배반포 3 → 동결 2│
└────────────────────────────────────────────┘
```
- 현재 시도 회차 표시 (예: "1차 시도")
- 완료 횟수, 남은 횟수, D-Day 표시
- **결과 요약 파이프라인**: 전체 흐름을 한눈에 표시
- [편집] 버튼으로 시도 정보 수정 가능

### 2. 치료 단계 리스트 (5단계 - 사용자 행동 중심)

| 단계 | 사용자가 하는 것 | 기록하는 것 |
|------|------------------|-------------|
| 1. 과배란 | 주사 맞기 | 주사 횟수, 기간, 메모 |
| 2. 채취 | 시술 받기 | 채취 난자 수, 성숙란 수, 메모 |
| 3. 이식 대기 | 결과 기다리기 | 병원 결과들 (수정/배양/동결) |
| 4. 이식 | 시술 받기 | 이식 배아 수, 내막 두께, 메모 |
| 5. 판정 | 결과 확인 | hCG 수치, 임신 여부 |

#### 단계 1: 과배란 (Stimulation)
```
┌────────────────────────────────────────────┐
│ ✅ 과배란 (Stimulation)             [편집] │
│    2025.01.01 ~ 01.10                      │
│    ┌──────────────┬──────────────┐        │
│    │ 💉 주사 횟수  │ 📅 기간      │        │
│    │    42회      │    10일     │        │
│    └──────────────┴──────────────┘        │
│    📝 왼쪽 배 쪽이 덜 아픔                 │
└────────────────────────────────────────────┘
```

#### 단계 2: 채취 (Retrieval)
```
┌────────────────────────────────────────────┐
│ ✅ 채취 (Retrieval)                 [편집] │
│    2025.01.11                              │
│    ┌──────────────┬──────────────┐        │
│    │ 🥚 채취 난자  │ 🧫 성숙란(M2)│        │
│    │    12개      │    10개     │        │
│    └──────────────┴──────────────┘        │
│    📝 왼쪽 6개, 오른쪽 6개                 │
└────────────────────────────────────────────┘
```

#### 단계 3: 이식 대기 ⭐ (핵심!)
**병원에서 연락 올 때마다 결과를 자유롭게 추가하는 단계**

```
┌────────────────────────────────────────────┐
│ ▶️ 이식 대기                [현재] [편집] │
│    2025.01.12 ~ 진행 중                    │
│                                            │
│  📞 병원 결과                              │
│  ┌────────────────────────────────────┐   │
│  │ 수정 결과       8개 (ICSI)         │   │
│  │ Day 3 배아      5개                │   │
│  │ Day 5 배반포    3개 (AA 1, AB 2)   │   │
│  │ 동결            2개                │   │
│  └────────────────────────────────────┘   │
│                                            │
│  ┌────────────────────────────────────┐   │
│  │      [+ 결과 추가하기]             │   │
│  └────────────────────────────────────┘   │
│                                            │
│  📝 1/16 이식 예정. AA등급 신선이식        │
└────────────────────────────────────────────┘
```

#### 단계 4: 이식 (Transfer)
```
┌────────────────────────────────────────────┐
│ ○ 이식 (Transfer)                   [편집] │
│    2025.01.16 예정                         │
│    ┌──────────────┬──────────────┐        │
│    │ 🎯 이식 배아  │ 📏 내막 두께 │        │
│    │    -개       │    -mm      │        │
│    └──────────────┴──────────────┘        │
└────────────────────────────────────────────┘
```

#### 단계 5: 판정 (Result)
```
┌────────────────────────────────────────────┐
│ ○ 판정 (Result)                     [편집] │
│    예정                                    │
│    ┌──────────────┬──────────────┐        │
│    │ 🩸 hCG 수치   │ 🤰 임신 여부 │        │
│    │    -         │    -        │        │
│    └──────────────┴──────────────┘        │
└────────────────────────────────────────────┘
```

### 3. 편집 모드 UI

**[편집] 버튼 누르면 → 입력 가능 모드로 전환**

```
일반 모드:
┌─────────────────────────────────────┐
│ 📞 병원 결과                 [편집] │
│                                     │
│  수정 결과        8개 (ICSI)        │
│  Day 3 배아       5개               │
│  Day 5 배반포     3개 (AA 1, AB 2)  │
│  동결             2개               │
└─────────────────────────────────────┘

        ↓ [편집] 누르면

편집 모드:
┌─────────────────────────────────────┐
│ 📞 병원 결과                 [완료] │
│                                     │
│  수정 결과     [  8  ] 개           │
│  수정 방법     [ICSI ▼]             │
│  Day 3 배아    [  5  ] 개           │
│  Day 5 배반포  [  3  ] 개           │
│  등급 메모     [AA 1, AB 2    ]     │
│  동결          [  2  ] 개           │
│                                     │
│  [🗑️ 삭제]                          │
└─────────────────────────────────────┘
```

**편집 모드 동작:**
- [편집] → [완료]로 버튼 텍스트 변경
- 각 항목이 입력 필드로 전환
- 숫자 필드 탭 시 숫자 키패드 표시
- 드롭다운 필드 (수정 방법 등)
- 텍스트 필드 (메모, 등급 메모 등)
- [완료] 누르면 저장 + 일반 모드로 복귀
- [삭제] 버튼은 맨 아래에 (빨간색, 확인 다이얼로그)

### 4. 결과 추가하기 플로우

[+ 결과 추가하기] 버튼 탭 시:

```
┌─────────────────────────────────────┐
│ 결과 추가                     [X]  │
├─────────────────────────────────────┤
│                                     │
│  어떤 결과인가요?                   │
│                                     │
│  ┌─────────┐ ┌─────────┐           │
│  │ 수정    │ │ Day 3   │           │
│  │ 결과    │ │ 배아    │           │
│  └─────────┘ └─────────┘           │
│  ┌─────────┐ ┌─────────┐           │
│  │ Day 5   │ │ 동결    │           │
│  │ 배반포  │ │ 결과    │           │
│  └─────────┘ └─────────┘           │
│  ┌─────────┐                       │
│  │ 기타    │                       │
│  └─────────┘                       │
│                                     │
└─────────────────────────────────────┘
```

선택 후 → 해당 결과 입력 바텀시트 표시

### 5. 통계 탭 - Funnel 시각화
```
채취 12개 ━━━━━━━━━━━━━━━━ 100%
    ↓
성숙란 10개 ━━━━━━━━━━━━━ 83%
    ↓
수정 8개 ━━━━━━━━━━━ 67%
    ↓
Day 3 5개 ━━━━━━ 42%
    ↓
배반포 3개 ━━━ 25%
    ↓
동결 2개 ━━ 17%
```

## 데이터 모델

```dart
class TreatmentCycle {
  int cycleNumber;        // 시도 회차
  DateTime startDate;
  List<TreatmentStage> stages;
}

class TreatmentStage {
  StageType type;         // stimulation, retrieval, waiting, transfer, result
  StageStatus status;     // completed, inProgress, pending
  DateTime? startDate;
  DateTime? endDate;
  String? memo;
  Map<String, dynamic> data;  // 단계별 상세 데이터
}

enum StageType {
  stimulation,  // 과배란
  retrieval,    // 채취
  waiting,      // 이식 대기
  transfer,     // 이식
  result,       // 판정
}

// 과배란 데이터
class StimulationData {
  int injectionCount;     // 주사 횟수
  int durationDays;       // 기간 (일)
}

// 채취 데이터
class RetrievalData {
  int totalEggs;          // 총 채취 난자
  int matureEggs;         // 성숙란 (M2)
}

// 이식 대기 - 병원 결과들 (자유롭게 추가)
class WaitingData {
  List<LabResult> results;  // 병원 결과 리스트
}

class LabResult {
  LabResultType type;     // fertilization, day3, day5, frozen, other
  DateTime recordedAt;
  int? count;
  String? method;         // IVF, ICSI, Split (수정 결과용)
  String? gradeNote;      // 등급 메모 (AA 1개, AB 2개 등)
  String? memo;
}

enum LabResultType {
  fertilization,  // 수정 결과
  day3,           // Day 3 배아
  day5,           // Day 5 배반포
  frozen,         // 동결
  other,          // 기타
}

// 이식 데이터
class TransferData {
  int? embryoCount;               // 이식 배아 수
  double? endometriumThickness;   // 내막 두께 (mm)
  String? embryoGrade;            // 이식 배아 등급
}

// 판정 데이터
class ResultData {
  double? hcgLevel;       // hCG 수치
  bool? isPregnant;       // 임신 여부
  DateTime? testDate;     // 검사일
}
```

---

# Part 2: 약물 추가 화면 개선

## 개요
기존 4단계 약물 입력 플로우를 **1페이지 단일 화면**으로 통합합니다.

## 기존 문제점
- 4단계(약물정보 → 복용시간 → 복용패턴 → 복용기간)가 너무 길다
- 시간 선택 휠 UI가 불편
- 복용 패턴이 라디오 버튼으로 제한적
- "자주 사용하는 약물" 칩이 복잡함

## 새로운 UI 구조 (단일 화면)

```
┌─────────────────────────────────────────────┐
│  ←        💊 약물 추가                       │
├─────────────────────────────────────────────┤
│                                             │
│  약 이름                                    │
│  ┌─────────────────────────────────────┐   │
│  │ 🔍 검색 또는 직접 입력               │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  종류                                       │
│  💉주사  💊알약  ⚪질정  🩹패치              │
│  ━━━━                                       │
│                                             │
│  언제 복용하나요? (여러 개 선택 가능)        │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐      │
│  │ 🌅   │ │ ☀️   │ │ 🌆   │ │ 🌙   │      │
│  │ 아침  │ │ 점심  │ │ 저녁  │ │ 취침  │      │
│  │  ✓   │ │  ✓   │ │  ✓   │ │      │      │
│  │08:00 │ │12:00 │ │18:00 │ │22:00 │      │
│  └──────┘ └──────┘ └──────┘ └──────┘      │
│  📍 탭: 선택/해제, 길게 누르기: 시간 수정    │
│                                             │
│  회당 수량: [-] 1 알 [+]                    │
│  → 하루 총 3알 (아침 1 + 점심 1 + 저녁 1)   │
│                                             │
│  복용일 선택                                │
│  [매일] [격일] [월수금] [화목토] [직접선택]  │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │  < 2025년 1월 >                      │   │
│  │  일  월  화  수  목  금  토           │   │
│  │      ●   ●   ●   ●   ●   ●          │   │
│  │  ●   ●   ●   ●   ●   ●   ●          │   │
│  │  ●   15  16  17  18  19  20          │   │
│  │  (●=선택됨, 탭으로 ON/OFF)           │   │
│  └─────────────────────────────────────┘   │
│  기간: 1/1 ~ 1/14 (14일간, 총 42회)        │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │             💾 저장                  │   │
│  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

### 1. 약 이름 입력
- 검색 기능 있는 텍스트 필드
- 자동완성으로 IVF 약물 제안:
  - 주사: 고나엘에프, 퓨레곤, 메노푸어, 세트로타이드, 오가루트란, 피르고닉스
  - 알약: 클로미펜, 레트로졸, 페마라, 타목시펜, 듀파스톤
  - 질정: 프로게스테론, 유트로게스탄, 크녹산
- 검색 결과 없으면 직접 입력 가능

### 2. 종류 선택 (가로 배치)
- 💉 주사 | 💊 알약 | ⚪ 질정 | 🩹 패치
- 탭으로 선택, 선택된 것은 보라색 하이라이트
- 약 이름 자동완성 시 종류도 자동 선택

### 3. 복용 시간대 선택 (다중 선택)
```dart
// 시간대 정의
enum TimeSlot {
  morning,  // 아침 (기본 08:00)
  noon,     // 점심 (기본 12:00)
  evening,  // 저녁 (기본 18:00)
  night,    // 취침 (기본 22:00)
}
```
- **탭**: 선택/해제 토글 (다중 선택 가능)
- **길게 누르기**: 해당 시간대의 시간 미세 조정 (바텀시트로 시간 선택)
- 선택된 시간대는 보라색 배경 + 체크 표시

### 4. 회당 수량
- 스테퍼: [-] 1 [+]
- 단위는 종류에 따라 자동 변경 (주사→대, 알약→알, 질정→개, 패치→장)
- 아래에 "하루 총 X회" 자동 계산 표시
  - 예: 아침/점심/저녁 선택 + 1알 = "하루 총 3알"

### 5. 복용일 선택
**빠른 선택 버튼 (칩 형태):**
- [매일] [격일] [월수금] [화목토] [직접선택]
- 탭하면 캘린더에 자동 반영

**미니 캘린더:**
- 날짜를 탭해서 직접 ON/OFF
- 선택된 날짜는 보라색 원(●)으로 표시
- 빠른 선택과 연동 (매일 누르면 전체 선택 등)

**하단 요약:**
- "기간: 1/1 ~ 1/14 (14일간, 총 42회)" 자동 계산

### 6. 저장 버튼
- 화면 하단 고정
- 필수 입력값(약 이름, 종류, 시간대 1개 이상, 복용일 1개 이상) 미입력 시 비활성화

## 데이터 모델

```dart
class Medication {
  String name;
  MedicationType type;        // injection, pill, suppository, patch
  List<TimeSlot> timeSlots;   // 선택된 시간대들
  Map<TimeSlot, TimeOfDay> customTimes;  // 사용자 지정 시간 (선택적)
  int quantityPerDose;        // 회당 수량
  List<DateTime> scheduledDates;  // 선택된 날짜들
  String? memo;
  
  // 계산 속성
  int get dailyTotal => timeSlots.length * quantityPerDose;
  int get totalDoses => scheduledDates.length * timeSlots.length;
}

enum MedicationType {
  injection,    // 주사 (단위: 대)
  pill,         // 알약 (단위: 알)
  suppository,  // 질정 (단위: 개)
  patch,        // 패치 (단위: 장)
}

enum TimeSlot {
  morning,   // 아침 08:00
  noon,      // 점심 12:00
  evening,   // 저녁 18:00
  night,     // 취침 22:00
}
```

## 사용 플로우 예시

### 예시 1: 듀파스톤 아침/점심/저녁 1알씩, 매일
1. 약 이름: "듀파스톤" 입력 (자동완성에서 선택)
2. 종류: 💊 알약 (자동 선택됨)
3. 시간대: 아침, 점심, 저녁 탭탭탭
4. 수량: 1알 (기본값)
5. 복용일: [매일] 탭
6. 저장

**→ 총 6탭으로 완료!**

### 예시 2: 고나엘에프 저녁 8시에 1대씩, 격일
1. 약 이름: "고나엘에프" 입력
2. 종류: 💉 주사 (자동 선택됨)
3. 시간대: 저녁 탭 → 길게 눌러서 20:00으로 변경
4. 수량: 1대
5. 복용일: [격일] 탭
6. 저장

---

# 공통 UI 요구사항

## 디자인 시스템
- **Primary Color**: 보라색 계열 (#9B7ED9 또는 유사)
- **상태 표시**:
  - ✅ 완료: 초록색
  - ▶️ 진행중: 보라색
  - ○ 예정: 회색
- **선택됨**: 보라색 배경 + 흰색 텍스트/아이콘
- **카드**: 흰색 배경, 약간의 그림자, 둥근 모서리 (12-16px)

## 인터랙션
- 탭: 선택/토글
- 길게 누르기: 상세 수정 (시간 등)
- 스와이프: 삭제 (옵션)

## 반응형
- 스크롤 가능한 단일 페이지
- 저장 버튼은 하단 고정 (SafeArea 고려)

---

# 첨부 이미지 설명
1. 치료기록 탭 현재 화면 - 기존 단계별 UI
2. 약물정보 1/4 단계 - 약 이름, 종류 선택
3. 복용시간 2/4 단계 - 시간 선택, 복용 패턴
4. 복용기간 3/4 단계 - 시작일/종료일 선택

---

# 우선순위

## Phase 1 (필수)
1. 약물 추가: 단일 페이지 레이아웃 구현
2. 약물 추가: 시간대 다중 선택 UI
3. 약물 추가: 캘린더 날짜 탭 선택 + 빠른 선택 버튼

## Phase 2
4. 치료 기록: 단계별 카드 UI + 확장/축소
5. 치료 기록: 각 단계 데이터 입력 필드
6. 치료 기록: 상단 결과 요약 파이프라인

## Phase 3
7. 치료 기록: 통계 탭 Funnel 시각화
8. 약물 추가: 약물 자동완성 DB 구축
