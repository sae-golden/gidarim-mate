# 시험관메이트 - 음성 입력 기능 개선

## 개선 사항 3가지

1. 여러 약 한번에 인식
2. 말하기 포맷 가이드 개선
3. 녹음파일 업로드 (서브 기능)

---

## UI 설계

### 음성 입력 메인 화면
```
┌─────────────────────────────────────────┐
│ ← 음성으로 입력                         │
├─────────────────────────────────────────┤
│                                         │
│              🎤                         │
│          (큰 보라색 원)                 │
│                                         │
│      탭하여 음성 입력 시작              │
│                                         │
│ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │
│                                         │
│ 💡 이렇게 말해보세요                    │
│                                         │
│   📝 [약 이름] + [종류] + [개수] + [시간]│
│                                         │
│   "프로기노바 알약 1개 아침 8시"        │
│   "아스피린 1개 저녁 식후"              │
│   "고나엘에프 주사 1개 밤 10시"         │
│                                         │
│   💬 여러 개 한번에 말해도 돼요!        │
│   "프로기노바 1개 아침, 아스피린 저녁,  │
│    고나엘에프 주사 밤 10시"             │
│                                         │
│ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │
│                                         │
│         📁 녹음파일로 입력하기          │
│            (작은 텍스트 링크)           │
│                                         │
└─────────────────────────────────────────┘
```

### 여러 약 인식 결과 화면
```
┌─────────────────────────────────────────┐
│ ← 음성으로 입력                         │
├─────────────────────────────────────────┤
│                                         │
│ 🎙️ 인식된 내용                          │
│ ┌─────────────────────────────────────┐ │
│ │ 프로기노바 1개 아침, 아스피린 저녁, │ │
│ │ 고나엘에프 주사 밤 10시             │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ✅ 인식 완료! (3개)                     │
│ ┌─────────────────────────────────────┐ │
│ │ ☑️ 💊 프로기노바                     │ │
│ │    알약 · 1개 · 아침                │ │
│ ├─────────────────────────────────────┤ │
│ │ ☑️ 💊 아스피린                       │ │
│ │    알약 · 1개 · 저녁 식후           │ │
│ ├─────────────────────────────────────┤ │
│ │ ☑️ 💉 고나엘에프                     │ │
│ │    주사 · 1개 · 밤 10시             │ │
│ └─────────────────────────────────────┘ │
│                                         │
│    [다시 녹음]        [전체 추가하기]   │
│                                         │
└─────────────────────────────────────────┘
```

### 녹음파일 업로드 화면
```
┌─────────────────────────────────────────┐
│ ← 녹음파일로 입력                       │
├─────────────────────────────────────────┤
│                                         │
│              📁                         │
│                                         │
│      탭하여 녹음파일 선택               │
│                                         │
│ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │
│                                         │
│ 💡 이런 파일을 올려보세요               │
│                                         │
│   • 병원에서 녹음한 설명               │
│   • 직접 녹음한 약 목록                │
│                                         │
│ 📌 지원 형식: mp3, m4a, wav            │
│                                         │
└─────────────────────────────────────────┘
```

---

## 인식 로직

### 입력 포맷
```
[약 이름] + [종류(선택)] + [개수] + [시간] + [기간(선택)]
```

### 파싱 예시
| 음성 입력 | 파싱 결과 |
|-----------|-----------|
| "프로기노바 알약 1개 아침 8시" | 약: 프로기노바, 종류: 알약, 수량: 1, 시간: 08:00 |
| "아스피린 1개 저녁 식후" | 약: 아스피린, 종류: 알약(기본), 수량: 1, 시간: 저녁 식후 |
| "고나엘에프 주사 밤 10시" | 약: 고나엘에프, 종류: 주사, 수량: 1, 시간: 22:00 |
| "프로기노바 1개 1월 4일까지" | 약: 프로기노바, 수량: 1, 기간: ~1/4 |

### 여러 약 구분자
- 쉼표 (,)
- "그리고", "랑", "하고"
- 문장 끊김 (pause)

### 시간 인식
| 음성 | 변환 |
|------|------|
| 아침 | 08:00 |
| 점심 | 12:00 |
| 저녁 | 18:00 |
| 밤 | 22:00 |
| 아침 식후 | 08:30 (식후 30분) |
| 저녁 식후 | 18:30 |
| 아침 8시 | 08:00 |
| 밤 10시 | 22:00 |

---

## 데이터 모델

```dart
class VoiceRecognitionResult {
  String rawText;                    // 원본 인식 텍스트
  List<ParsedMedication> medications; // 파싱된 약물 목록
  double confidence;                 // 인식 신뢰도
}

class ParsedMedication {
  String name;           // 약 이름
  MedicationType type;   // 알약/주사/질정/패치
  int quantity;          // 개수
  String? timeText;      // 시간 텍스트 ("아침 8시")
  TimeOfDay? time;       // 파싱된 시간
  DateTime? endDate;     // 종료일 (있는 경우)
  bool isSelected;       // 추가 선택 여부 (기본 true)
}
```

---

## 구현 우선순위

| 순위 | 기능 | 설명 |
|------|------|------|
| P0 | 여러 약 동시 인식 | 쉼표/구분자로 분리 |
| P0 | 말하기 가이드 개선 | 자연스러운 예시 |
| P1 | 선택적 추가 | 체크박스로 일부만 추가 |
| P2 | 녹음파일 업로드 | 서브 기능 |

---

## 참고: 용량 처리

사용자는 "1개", "2개"로 말하고,  
실제 용량(mg, IU)은 **약 DB에서 자동 매칭**

```dart
// 약 선택 시 기본 용량 자동 설정
final defaultDosage = medicationDB.getDefaultDosage('프로기노바');
// → 2mg

final defaultDosage = medicationDB.getDefaultDosage('고나엘에프');
// → 75IU, 150IU, 225IU 등 선택지 제공
```
